<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"></head>
<body class="d-flex flex-column min-vh-100">
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-shrink-0">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-box-seam text-warning"></i> Sealed Pokémon</h2>
                <a th:href="@{/pokemon/sealed/new}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Nuovo Sealed
                </a>
            </div>

            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Riepilogo stato prodotti -->
            <div class="stato-summary" th:if="${!#lists.isEmpty(sealedList)}">
                <div class="stato-summary-item summary-totale">
                    <i class="bi bi-box-seam-fill"></i>
                    <span>Totale: <strong th:text="${#lists.size(sealedList)}">0</strong></span>
                </div>
                <div class="stato-summary-item summary-disponibile">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Disponibili: <strong th:text="${sealedList.?[stato == 'DISPONIBILE' || stato == 'disponibile'].size()}">0</strong></span>
                </div>
                <div class="stato-summary-item summary-venduto">
                    <i class="bi bi-x-circle-fill"></i>
                    <span>Venduti: <strong th:text="${sealedList.?[stato == 'VENDUTO' || stato == 'venduto'].size()}">0</strong></span>
                </div>
            </div>

            <!-- Filtri stato -->
            <div class="filter-buttons" th:if="${!#lists.isEmpty(sealedList)}">
                <button class="btn btn-outline-primary filter-btn active" onclick="filterByStatus('all')">
                    <i class="bi bi-grid-fill"></i> Tutti
                </button>
                <button class="btn btn-outline-success filter-btn" onclick="filterByStatus('disponibile')">
                    <i class="bi bi-check-circle"></i> Solo Disponibili
                </button>
                <button class="btn btn-outline-danger filter-btn" onclick="filterByStatus('venduto')">
                    <i class="bi bi-x-circle"></i> Solo Venduti
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="sealedTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Nome</th>
                            <th>Espansione</th>
                            <th>Codice Prodotto</th>
                            <th>Prezzo Acquisto</th>
                            <th>Data Acquisto</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="sealed : ${sealedList}"
                            th:classappend="${sealed.stato == 'DISPONIBILE' || sealed.stato == 'disponibile' ? 'row-disponibile' : 'row-venduto'}"
                            th:attr="data-status=${sealed.stato}">
                            <td th:text="${sealed.nome}"></td>
                            <td th:text="${sealed.espansione}"></td>
                            <td th:text="${sealed.codiceProdotto}"></td>
                            <td th:text="${#numbers.formatDecimal(sealed.prezzoAcquisto, 1, 2)} + ' €'"></td>
                            <td th:text="${sealed.dataInserimentoAcquisto}"></td>
                            <td>
                                <span th:if="${sealed.stato == 'DISPONIBILE' || sealed.stato == 'disponibile'}"
                                      class="badge badge-stato badge-disponibile">
                                    <i class="bi bi-check-circle-fill stato-icon"></i>
                                    Disponibile
                                </span>
                                <span th:if="${sealed.stato == 'VENDUTO' || sealed.stato == 'venduto'}"
                                      class="badge badge-stato badge-venduto">
                                    <i class="bi bi-bag-check-fill stato-icon"></i>
                                    Venduto
                                </span>
                                <span th:if="${sealed.stato != 'DISPONIBILE' && sealed.stato != 'disponibile' && sealed.stato != 'VENDUTO' && sealed.stato != 'venduto'}"
                                      class="badge badge-stato badge-non-disponibile">
                                    <i class="bi bi-question-circle-fill stato-icon"></i>
                                    <span th:text="${sealed.stato}">N/D</span>
                                </span>
                            </td>
                            <td>
                                <a th:href="@{/pokemon/sealed/{id}/edit(id=${sealed.id})}"
                                   class="btn btn-sm btn-warning"
                                   th:title="${sealed.stato == 'VENDUTO' || sealed.stato == 'venduto' ? 'Modifica (già venduto)' : 'Modifica'}">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a th:if="${sealed.stato == 'DISPONIBILE' || sealed.stato == 'disponibile'}"
                                   th:href="@{/pokemon/sealed/{id}/vendita(id=${sealed.id})}"
                                   class="btn btn-sm btn-success"
                                   title="Vendi sealed">
                                    <i class="bi bi-cart-check"></i>
                                </a>
                                <a th:href="@{/pokemon/sealed/{id}/delete(id=${sealed.id})}"
                                   class="btn btn-sm btn-danger"
                                   th:title="${sealed.stato == 'VENDUTO' || sealed.stato == 'venduto' ? 'Elimina vendita' : 'Elimina sealed'}"
                                   onclick="return confirm('Sei sicuro di voler eliminare questo sealed?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(sealedList)}">
                            <td colspan="7" class="text-center">Nessun sealed trovato</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <script>
                // Funzione per filtrare le righe per stato
                function filterByStatus(status) {
                    const table = document.getElementById('sealedTable');
                    const rows = table.querySelectorAll('tbody tr[data-status]');
                    const buttons = document.querySelectorAll('.filter-btn');

                    // Aggiorna bottoni attivi
                    buttons.forEach(btn => btn.classList.remove('active'));
                    event.target.closest('.filter-btn').classList.add('active');

                    // Filtra righe
                    rows.forEach(row => {
                        const rowStatus = row.getAttribute('data-status').toLowerCase();
                        if (status === 'all') {
                            row.style.display = '';
                        } else if (status === 'disponibile') {
                            row.style.display = rowStatus === 'disponibile' ? '' : 'none';
                        } else if (status === 'venduto') {
                            row.style.display = rowStatus === 'venduto' ? '' : 'none';
                        }
                    });
                }
            </script>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
